// ==================== SİSTEM KONFİGÜRASYONU ====================
    const CONFIG = {
        API_URL: 'https://api.ipify.org?format=json',
        REDIRECT_URL: 'https://lytradev.xyz',
        STORAGE_KEY: 'egm_system_data',
        ADMIN_PASSWORD: '123456', // Değiştirilmiş şifre
        VERSION: '1.0.0'
    };

    // ==================== VERİ YÖNETİMİ ====================
    class SystemManager {
        constructor() {
            this.data = this.loadData();
            this.checkBlockStatus();
            this.logVisit();
            this.bindEvents();
        }

        loadData() {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error("Veri yükleme hatası, yeni veri oluşturuluyor:", e);
                }
            }
            
            return this.getDefaultData();
        }

        getDefaultData() {
            return {
                visitors: [],
                blockedIPs: [],
                blockedDevices: [],
                devices: [],
                settings: {
                    redirectUrl: CONFIG.REDIRECT_URL,
                    cleanupDays: 30,
                    lastCleanup: new Date().toISOString()
                },
                adminLog: [],
                stats: {
                    totalVisits: 0,
                    uniqueIPs: [],
                    uniqueDevices: []
                }
            };
        }

        saveData() {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(this.data));
            return true;
        }

        bindEvents() {
            // Buton eventlerini bağla
            setTimeout(() => {
                if (document.getElementById('adminOverlay')) {
                    document.getElementById('adminOverlay').addEventListener('click', closeAdminPanel);
                }
                
                // Admin paneldeki butonları bağla
                document.addEventListener('click', (e) => {
                    if (e.target && e.target.classList && e.target.classList.contains('btn-block')) {
                        const ip = e.target.getAttribute('data-ip');
                        if (ip && this.blockIP(ip)) {
                            alert(`IP engellendi: ${ip}`);
                            this.updateDisplay();
                        }
                    }
                    
                    if (e.target && e.target.classList && e.target.classList.contains('btn-unblock')) {
                        const ip = e.target.getAttribute('data-ip');
                        if (ip && this.unblockIP(ip)) {
                            alert(`IP engeli kaldırıldı: ${ip}`);
                            this.updateDisplay();
                        }
                    }
                });
            }, 100);
        }

        // ==================== IP YÖNETİMİ ====================
        async getIP() {
            try {
                const response = await fetch(CONFIG.API_URL);
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("IP alınamadı, rastgele üretiliyor:", error);
                // Fallback: Rastgele IP üret
                return `192.168.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
            }
        }

        generateDeviceId() {
            const components = [
                navigator.userAgent,
                navigator.platform,
                screen.width + 'x' + screen.height,
                navigator.language,
                !!navigator.cookieEnabled
            ];
            const str = components.join('|');
            // Basit hash oluştur
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // ==================== ZİYARET KAYDI ====================
        async logVisit() {
            try {
                const ip = await this.getIP();
                const deviceId = this.generateDeviceId();
                const now = new Date();
                const nowISO = now.toISOString();
                const dateStr = now.toLocaleDateString('tr-TR');
                const timeStr = now.toLocaleTimeString('tr-TR');

                // Engelleme kontrolü
                if (this.isBlocked(ip, deviceId)) {
                    console.log("Engellenmiş kullanıcı, yönlendiriliyor:", ip);
                    window.location.href = this.data.settings.redirectUrl;
                    return;
                }

                // Cihaz bilgileri
                const deviceInfo = {
                    id: deviceId,
                    userAgent: navigator.userAgent.substring(0, 100),
                    platform: navigator.platform,
                    language: navigator.language,
                    screen: `${screen.width}x${screen.height}`,
                    cookies: navigator.cookieEnabled,
                    lastSeen: nowISO,
                    firstSeen: nowISO,
                    visitCount: 1
                };

                // Mevcut cihazı güncelle veya yeni ekle
                const existingDeviceIndex = this.data.devices.findIndex(d => d.id === deviceId);
                if (existingDeviceIndex !== -1) {
                    this.data.devices[existingDeviceIndex].lastSeen = nowISO;
                    this.data.devices[existingDeviceIndex].visitCount++;
                } else {
                    this.data.devices.push(deviceInfo);
                }

                // Ziyaret kaydı
                const visit = {
                    timestamp: nowISO,
                    ip: ip,
                    deviceId: deviceId,
                    browser: this.getBrowserName(),
                    os: this.getOSName(),
                    date: dateStr,
                    time: timeStr,
                    referrer: document.referrer || 'direct'
                };

                this.data.visitors.unshift(visit);
                this.data.stats.totalVisits++;
                
                // Benzersiz IP ekle
                if (!this.data.stats.uniqueIPs.includes(ip)) {
                    this.data.stats.uniqueIPs.push(ip);
                }
                
                // Benzersiz cihaz ekle
                if (!this.data.stats.uniqueDevices.includes(deviceId)) {
                    this.data.stats.uniqueDevices.push(deviceId);
                }

                // 500 kayıtla sınırla
                if (this.data.visitors.length > 500) {
                    this.data.visitors = this.data.visitors.slice(0, 500);
                }

                this.saveData();
                this.updateDisplay();
                
            } catch (error) {
                console.error("Ziyaretçi kaydı hatası:", error);
            }
        }

        // ==================== ENGELLEME SİSTEMİ ====================
        isBlocked(ip, deviceId) {
            const ipBlocked = this.data.blockedIPs.some(item => 
                item.value === ip && item.active === true
            );
            
            const deviceBlocked = this.data.blockedDevices.some(item => 
                item.value === deviceId && item.active === true
            );

            return ipBlocked || deviceBlocked;
        }

        blockIP(ip, reason = 'Admin engellemesi') {
            const existing = this.data.blockedIPs.find(item => item.value === ip);
            
            if (existing) {
                existing.active = true;
                existing.reason = reason;
                existing.blockedAt = new Date().toISOString();
                existing.blockedBy = 'admin';
            } else {
                this.data.blockedIPs.push({
                    value: ip,
                    type: 'ip',
                    active: true,
                    reason: reason,
                    blockedAt: new Date().toISOString(),
                    blockedBy: 'admin'
                });
            }

            this.saveData();
            return true;
        }

        unblockIP(ip) {
            const item = this.data.blockedIPs.find(item => item.value === ip);
            if (item) {
                item.active = false;
                this.saveData();
                return true;
            }
            return false;
        }

        blockDevice(deviceId, reason = 'Admin engellemesi') {
            const existing = this.data.blockedDevices.find(item => item.value === deviceId);
            
            if (existing) {
                existing.active = true;
                existing.reason = reason;
                existing.blockedAt = new Date().toISOString();
                existing.blockedBy = 'admin';
            } else {
                this.data.blockedDevices.push({
                    value: deviceId,
                    type: 'device',
                    active: true,
                    reason: reason,
                    blockedAt: new Date().toISOString(),
                    blockedBy: 'admin'
                });
            }

            this.saveData();
            return true;
        }

        unblockDevice(deviceId) {
            const item = this.data.blockedDevices.find(item => item.value === deviceId);
            if (item) {
                item.active = false;
                this.saveData();
                return true;
            }
            return false;
        }

        // ==================== YARDIMCI FONKSİYONLAR ====================
        getBrowserName() {
            const ua = navigator.userAgent;
            if (ua.includes("Chrome")) return "Chrome";
            if (ua.includes("Firefox")) return "Firefox";
            if (ua.includes("Safari")) return "Safari";
            if (ua.includes("Edge")) return "Edge";
            if (ua.includes("Opera")) return "Opera";
            return "Bilinmeyen";
        }

        getOSName() {
            const ua = navigator.userAgent;
            if (ua.includes("Windows")) return "Windows";
            if (ua.includes("Mac")) return "MacOS";
            if (ua.includes("Linux")) return "Linux";
            if (ua.includes("Android")) return "Android";
            if (ua.includes("iOS")) return "iOS";
            return "Bilinmeyen";
        }

        getStats() {
            const today = new Date().toLocaleDateString('tr-TR');
            const todayVisits = this.data.visitors.filter(v => v.date === today).length;

            return {
                totalVisits: this.data.visitors.length,
                blockedIPs: this.data.blockedIPs.filter(item => item.active).length,
                blockedDevices: this.data.blockedDevices.filter(item => item.active).length,
                uniqueDevices: this.data.stats.uniqueDevices.length,
                todayVisits: todayVisits
            };
        }

        // ==================== GÖRSELLEŞTİRME ====================
        updateDisplay() {
            if (!document.getElementById('totalVisitors')) return;
            
            const stats = this.getStats();
            
            document.getElementById('totalVisitors').textContent = stats.totalVisits;
            document.getElementById('blockedCount').textContent = stats.blockedIPs + stats.blockedDevices;
            document.getElementById('uniqueDevices').textContent = stats.uniqueDevices;
            document.getElementById('todayVisits').textContent = stats.todayVisits;

            // Tabloları güncelle
            this.updateRecentLogs();
            this.updateIPTables();
            this.updateDeviceTable();
            this.updateBlockedTable();
        }

        updateRecentLogs() {
            const tbody = document.querySelector('#recentLogs tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const recent = this.data.visitors.slice(0, 10);
            
            recent.forEach(visit => {
                const row = document.createElement('tr');
                const isBlocked = this.isBlocked(visit.ip, visit.deviceId);
                
                row.innerHTML = `
                    <td>${visit.date} ${visit.time}</td>
                    <td style="font-family: monospace;">${visit.ip}</td>
                    <td>${visit.os}</td>
                    <td>${visit.browser}</td>
                    <td><span class="badge ${isBlocked ? 'badge-danger' : 'badge-success'}">
                        ${isBlocked ? 'Engelli' : 'Aktif'}
                    </span></td>
                `;
                tbody.appendChild(row);
            });
        }

        updateIPTables() {
            const tbody = document.getElementById('ipTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // IP'leri grupla
            const ipGroups = {};
            this.data.visitors.forEach(v => {
                if (!ipGroups[v.ip]) {
                    ipGroups[v.ip] = {
                        count: 0,
                        lastVisit: v.timestamp,
                        lastVisitStr: `${v.date} ${v.time}`
                    };
                }
                ipGroups[v.ip].count++;
                if (new Date(v.timestamp) > new Date(ipGroups[v.ip].lastVisit)) {
                    ipGroups[v.ip].lastVisit = v.timestamp;
                    ipGroups[v.ip].lastVisitStr = `${v.date} ${v.time}`;
                }
            });
            
            // Tabloyu doldur
            Object.keys(ipGroups).forEach(ip => {
                const group = ipGroups[ip];
                const isBlocked = this.data.blockedIPs.some(item => item.value === ip && item.active);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: monospace;">${ip}</td>
                    <td>${group.lastVisitStr}</td>
                    <td>${group.count}</td>
                    <td><span class="badge ${isBlocked ? 'badge-danger' : 'badge-success'}">
                        ${isBlocked ? 'Engelli' : 'Aktif'}
                    </span></td>
                    <td>
                        <button class="btn ${isBlocked ? 'btn-unblock' : 'btn-block'}" 
                                data-ip="${ip}">
                            ${isBlocked ? 'Engeli Kaldır' : 'Engelle'}
                        </button>
                        <button class="btn btn-delete" onclick="deleteIPData('${ip}')">Sil</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        updateDeviceTable() {
            const tbody = document.getElementById('deviceTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            this.data.devices.forEach(device => {
                const isBlocked = this.data.blockedDevices.some(item => item.value === device.id && item.active);
                const lastSeen = new Date(device.lastSeen).toLocaleString('tr-TR');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${device.id}">${device.id.substring(0, 8)}...</td>
                    <td>${this.getBrowserNameFromUA(device.userAgent)}</td>
                    <td>${device.platform}</td>
                    <td>${device.screen}</td>
                    <td>${lastSeen}</td>
                    <td>
                        <button class="btn ${isBlocked ? 'btn-unblock' : 'btn-block'}" 
                                onclick="${isBlocked ? 'systemManager.unblockDevice' : 'systemManager.blockDevice'}('${device.id}')">
                            ${isBlocked ? 'Engeli Kaldır' : 'Engelle'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        updateBlockedTable() {
            const tbody = document.getElementById('blockedTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Engellenen IP'ler
            this.data.blockedIPs.filter(item => item.active).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>IP Adresi</td>
                    <td style="font-family: monospace;">${item.value}</td>
                    <td>${new Date(item.blockedAt).toLocaleString('tr-TR')}</td>
                    <td>${item.blockedBy}</td>
                    <td>
                        <button class="btn btn-unblock" onclick="systemManager.unblockIP('${item.value}')">
                            Engeli Kaldır
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Engellenen cihazlar
            this.data.blockedDevices.filter(item => item.active).forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>Cihaz</td>
                    <td title="${item.value}">${item.value.substring(0, 8)}...</td>
                    <td>${new Date(item.blockedAt).toLocaleString('tr-TR')}</td>
                    <td>${item.blockedBy}</td>
                    <td>
                        <button class="btn btn-unblock" onclick="systemManager.unblockDevice('${item.value}')">
                            Engeli Kaldır
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        getBrowserNameFromUA(ua) {
            if (ua.includes("Chrome")) return "Chrome";
            if (ua.includes("Firefox")) return "Firefox";
            if (ua.includes("Safari")) return "Safari";
            return "Diğer";
        }

        // ==================== ENGELLEME KONTROLÜ ====================
        checkBlockStatus() {
            this.getIP().then(ip => {
                const deviceId = this.generateDeviceId();
                if (this.isBlocked(ip, deviceId)) {
                    window.location.href = this.data.settings.redirectUrl;
                }
            });
        }
    }

    // ==================== GLOBAL DEĞİŞKENLER ====================
    let systemManager;

    // ==================== SAYFA YÜKLEME ====================
    document.addEventListener('DOMContentLoaded', function() {
        systemManager = new SystemManager();
        
        // İlk kategoriyi aç
        const firstCategory = document.querySelector('.category');
        if (firstCategory) {
            firstCategory.classList.add('expanded');
        }
    });

    // ==================== ADMIN PANEL FONKSİYONLARI ====================
    function openAdminPanel() {
        // Basit şifre sorma
        const password = prompt('Yönetici şifresini girin:', '');
        
        if (password === CONFIG.ADMIN_PASSWORD) {
            document.getElementById('adminOverlay').classList.add('active');
            document.getElementById('adminPanel').classList.add('active');
            systemManager.updateDisplay();
        } else if (password !== null) {
            alert('Hatalı şifre! Varsayılan şifre: 123456');
        }
    }

    function closeAdminPanel() {
        document.getElementById('adminOverlay').classList.remove('active');
        document.getElementById('adminPanel').classList.remove('active');
    }

    function switchTab(tabName) {
        // Tüm tabları ve içerikleri gizle
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.admin-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Seçilen tabı aktif et
        document.querySelector(`.admin-tab[onclick*="${tabName}"]`).classList.add('active');
        document.getElementById(tabName).classList.add('active');
    }

    // ==================== İŞLEM FONKSİYONLARI ====================
    function blockIP() {
        const ipInput = document.getElementById('blockIpInput');
        const ip = ipInput.value.trim();
        
        if (!ip) {
            alert('IP adresi gerekli!');
            return;
        }
        
        if (systemManager.blockIP(ip)) {
            alert(`IP engellendi: ${ip}`);
            ipInput.value = '';
            systemManager.updateDisplay();
        }
    }

    function deleteIPData(ip) {
        if (confirm(`Bu IP'ye ait tüm kayıtlar silinecek. Emin misiniz?`)) {
            systemManager.data.visitors = systemManager.data.visitors.filter(v => v.ip !== ip);
            systemManager.saveData();
            systemManager.updateDisplay();
            alert('IP kayıtları temizlendi!');
        }
    }

    function saveSettings() {
        const redirectUrl = document.getElementById('redirectUrl').value;
        const cleanupDays = document.getElementById('cleanupDays').value;
        
        systemManager.data.settings.redirectUrl = redirectUrl;
        systemManager.data.settings.cleanupDays = parseInt(cleanupDays);
        systemManager.saveData();
        
        alert('Ayarlar kaydedildi!');
    }

    function exportData() {
        const dataStr = JSON.stringify(systemManager.data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', `egm_backup_${new Date().toISOString().split('T')[0]}.json`);
        linkElement.click();
        
        alert('Veriler dışa aktarıldı!');
    }

    function importData() {
        alert('Bu özellik şu anda kullanılamıyor. Manuel olarak localStorage\'dan yönetin.');
    }

    function clearAllData() {
        if (confirm('TÜM VERİLER SİLİNECEK! Emin misiniz?')) {
            localStorage.removeItem(CONFIG.STORAGE_KEY);
            systemManager.data = systemManager.getDefaultData();
            systemManager.saveData();
            systemManager.updateDisplay();
            alert('Tüm veriler temizlendi!');
        }
    }

    function filterLogs(searchTerm) {
        const rows = document.querySelectorAll('#recentLogs tbody tr');
        searchTerm = searchTerm.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }

    // ==================== MEVCUT FONKSİYONLAR ====================
    window.addEventListener("load", function () {
        // Uyarı mesajını basitleştir
        setTimeout(() => {
            alert("EGM Siber Suçlarla Mücadele Daire Başkanlığı\n\nBu sistem sadece yetkili personel içindir.");
        }, 1000);
    });

    function toggleCategory(categoryElement) {
        if (event.target.closest('.query-item')) {
            return;
        }
        categoryElement.classList.toggle('expanded');
    }

    function executeQuery(protocol) {
        event.stopPropagation(); 
        const item = event.target.closest('.query-item');
        item.style.background = 'rgba(0, 255, 255, 0.15)';
        
        setTimeout(() => {
            alert('Demo Modu: Gerçek sorgu yapılmaz.');
            item.style.background = '';
        }, 200);
    }

    // Admin panel açma kısayolu
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            openAdminPanel();
        }
    });

    // Global erişim
    window.systemManager = systemManager;
    window.openAdminPanel = openAdminPanel;
    window.closeAdminPanel = closeAdminPanel;
    window.switchTab = switchTab;
    window.blockIP = blockIP;
    window.deleteIPData = deleteIPData;
    window.saveSettings = saveSettings;
    window.exportData = exportData;
    window.importData = importData;
    window.clearAllData = clearAllData;
    window.filterLogs = filterLogs;
    window.toggleCategory = toggleCategory;
    window.executeQuery = executeQuery
