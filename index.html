// User management system
let users = JSON.parse(localStorage.getItem('lytradev_users')) || [];
let currentUser = null;

function loadUserManagement() {
    // Populate the assigned site dropdown
    assignedSiteSelect.innerHTML = '<option value="">Select a site</option>';
    knownFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file;
        option.textContent = file;
        assignedSiteSelect.appendChild(option);
    });
    
    // Display existing users
    displayUsers();
}

function displayUsers() {
    if (users.length === 0) {
        userList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No users created yet.</p>';
        return;
    }
    
    userList.innerHTML = '';
    users.forEach((user, index) => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.innerHTML = `
            <div class="user-info">
                <div class="user-name">${user.username}</div>
                <div class="user-assigned">Assigned site: ${user.assignedSite || 'None'}</div>
            </div>
            <div class="user-actions">
                <button class="action-btn edit" data-index="${index}">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" data-index="${index}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        userList.appendChild(userItem);
    });
    
    // Add event listeners for edit and delete buttons
    document.querySelectorAll('.action-btn.edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            editUser(index);
        });
    });
    
    document.querySelectorAll('.action-btn.delete').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            deleteUser(index);
        });
    });
}

function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    const assignedSite = document.getElementById('assignedSite').value;
    
    if (!username || !password) {
        userErrorMessage.textContent = 'Username and password are required.';
        userErrorMessage.style.display = 'block';
        userSuccessMessage.style.display = 'none';
        return;
    }
    
    // Check if username already exists
    if (users.some(user => user.username === username)) {
        userErrorMessage.textContent = 'Username already exists.';
        userErrorMessage.style.display = 'block';
        userSuccessMessage.style.display = 'none';
        return;
    }
    
    // Create new user
    const newUser = {
        username: username,
        password: password, // In a real app, this should be hashed!
        assignedSite: assignedSite
    };
    
    users.push(newUser);
    
    // Save to localStorage
    localStorage.setItem('lytradev_users', JSON.stringify(users));
    
    // Show success message
    userSuccessMessage.style.display = 'block';
    userErrorMessage.style.display = 'none';
    
    // Reset form
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('assignedSite').value = '';
    
    // Update user list
    displayUsers();
    
    // Hide success message after 3 seconds
    setTimeout(() => {
        userSuccessMessage.style.display = 'none';
    }, 3000);
    
    // Debug: log the created user
    console.log('Created user:', newUser);
    console.log('All users:', users);
}

function editUser(index) {
    const user = users[index];
    document.getElementById('newUsername').value = user.username;
    document.getElementById('newPassword').value = user.password;
    document.getElementById('assignedSite').value = user.assignedSite;
    
    // Remove the user from the list (will be re-added when created)
    users.splice(index, 1);
    localStorage.setItem('lytradev_users', JSON.stringify(users));
    displayUsers();
}

function deleteUser(index) {
    if (confirm('Are you sure you want to delete this user?')) {
        users.splice(index, 1);
        localStorage.setItem('lytradev_users', JSON.stringify(users));
        displayUsers();
    }
}

// Improved checkCredentials function with debugging
function checkCredentials(u, p) {
    console.log('Login attempt:', u, p);
    console.log('Available users:', users);
    
    // Check if it's the admin
    const chars = [76,121,116,114,97,100,101,118,49,52,53,33,33];
    let correctPass = "";
    for (let i = 0; i < chars.length; i++) {
        correctPass += String.fromCharCode(chars[i]);
    }
    
    if (u === "admin" && p === correctPass) {
        console.log('Admin login successful');
        return { role: 'admin' };
    }
    
    // Check if it's a customer user
    const user = users.find(user => user.username === u && user.password === p);
    if (user) {
        console.log('Customer login successful:', user);
        return { role: 'customer', username: user.username, assignedSite: user.assignedSite };
    }
    
    console.log('Login failed - no matching user found');
    return null;
}
